---
title: "Let's Practice Spatial data and cartography with R"
author: "Kim A. Etienne C. Timothée G."
date: "**SatRday Paris** February 2019"
output:
  unilur::tutorial_html_solution:
    toc: true
    toc_float: false
    toc_depth: 1
    suffix: ""
    theme: journal
    highlight: kate
    number_sections: no
    number_subsections: no
---

```{r knitr_init, echo=FALSE, cache=FALSE, include=FALSE}
library(stringr)
library(knitr)
## Global options
options(max.print="90")
opts_chunk$set(echo=TRUE,
               cache=FALSE, #TRUE
               prompt=FALSE,
               tidy=FALSE,
               comment=NA,
               message=FALSE,
               warning=FALSE)
opts_knit$set(width=90)
options(width = 90)

# no margins
knit_hooks$set(nm = function(before, options, envir){
  if (before){
    par(mar=c(0,0,0,0))
  }
})

# title margins
knit_hooks$set(sm = function(before, options, envir){
  if (before){
    par(mar=c(0,0,1.2,0))
  }
})

# boxes custom
#devtools::install_github("koncina/unilur")
knitr::opts_template$set(alert = list(box.title = "Watch out!",
                                      box.body = list(fill = "#ffe0d9", colour = "black"),
                                      box.header = list(fill = "#FFAD99", colour = "black"),
                                      box.collapse = NULL,
                                      box.icon = "fa-exclamation-triangle"))
knitr::opts_template$set(solution = list(box.title = "Solution",
                                         box.body = list(fill = "#e6f6e7", colour = "black"),
                                         box.header = list(fill = "#ace1af", colour = "black"),
                                         box.icon = "fa-check-square",
                                         box.collapse = TRUE))
knitr::opts_template$set(information = list(box.title = "Information",
                                            box.body = list(fill = "#bbe8f4", colour = "black"),
                                            box.header = list(fill = "#64c9e6", colour = "black"),
                                            box.icon = "fa-info-circle",
                                            box.collapse = NULL))
knitr::opts_template$set(clues = list(box.title = "Clues",
                                      box.body = list(fill = "#fff9dc", colour = "black"),
                                      box.header = list(fill = "#ffec8b", colour = "black"),
                                      box.icon = "fa-search",
                                      box.collapse = TRUE))
```

The main dataset used in this tutorial is about the **geolocalisation of french restaurants** in Paris. Data is extracted from an official register called [**SIRENE**](https://www.data.gouv.fr/fr/datasets/base-sirene-des-entreprises-et-de-leurs-etablissements-siren-siret/) (Computer system for the business and establishment register) managed by the French National Institute of Statistics and Economic Studies ([Insee](https://www.insee.fr/en/accueil)) and [geolocated](http://data.cquest.org/geo_sirene/last/) by [Etalab](https://www.etalab.gouv.fr/) (French task force for Open Data). This register records the civil status of all companies and their establishments (including restaurants).
SIRENE has the advantages of being rigorous and exhaustive on the French territory.



# Exercise 1 : Manipulate sf objects and associated data.frames

```{block, box.title = "1", box.body = list(fill = "white"), box.icon = "fa-star"}
Import the iris[^1] map layer 'iris_75.shp' of Paris.
```


[^1]: In French, IRIS is an acronym of ‘aggregated units for statistical information’. Their target sizes are 2000 residents per basic unit.

```{block, opts.label = "clues"}
Use `sf::st_read()`.
```

```{r, solution = TRUE}
library(sf)
iris_75 <- st_read("data/iris_75.shp")
```



```{block, box.title = "2", box.body = list(fill = "white"), box.icon = "fa-star"}
Display the basemap of Paris with `plot(iris_75)`.
What do you notice ?
```

```{r, nm=TRUE, solution = TRUE}
plot(iris_75)
```

```{block, solution = TRUE}
We notice that R performs 4 graphs: one graph per variable in the sf object.
```

```{block, box.title = "3", box.body = list(fill = "white"), box.icon = "fa-star"}
What is the functionality of the `sf::st_geometry()` function? What solution do you propose then?
```

```{block, solution = TRUE}
`sf::st_geometry()` makes it possible to isolate the information contained in the 'geometry' column of the sf object. Using it, we put aside other variables (here *CODE_IRIS*, *P14_POP*, *AREA* and *CODE_COM*).
```


```{r, nm=TRUE, solution = TRUE}
plot(st_geometry(iris_75))
```



```{block, box.title = "4", box.body = list(fill = "white"), box.icon = "fa-star"}
Import the restaurant layer 'sir.shp' and display a map of Paris with its restaurants. 
```

```{block, solution = TRUE}
Use `st_read()` and `sf::st_geometry()`.
```


```{r, sm=TRUE, solution = TRUE}
sir_75 <- st_read("data/sir_75.shp")
plot(st_geometry(iris_75), bg = "cornsilk", col = "lightblue", 
     border = "white", lwd = .5)
plot(st_geometry(sir_75), col = "red", pch = 20, cex = .2, add=TRUE)
title("Restaurants in Paris")
```



```{block, box.title = "5", box.body = list(fill = "white"), box.icon = "fa-star"}
Count the number of restaurant by iris. 
```

```{block, opts.label = "clues"}
Use `sf::st_intersects()` and `sapply()`.
```


```{r, nm=TRUE, solution = TRUE}
inter <- st_intersects(x = iris_75, y = sir_75)
iris_75$RESTAU <- sapply(inter, length)
head(iris_75)
```



```{block, box.title = "6", box.body = list(fill = "white"), box.icon = "fa-star"}
Using the layer called ‘iris_75’, create a new aggregated map layer called ‘com_75’ which corresponds to the Paris Arrondissements. Also keep in this new layer the information on the population, area and number of restaurant in each municipality.
```

```{block, opts.label = "information"}
The map layer called ‘iris_75’ contains the 5 digit codes of arrondissemnt in its variable *CODE_COM*.
```

```{block, opts.label = "clues"}
Use the classic functions of `dplyr` package: `select`, `group_by` et `summarize`.
These functions also work with `sf` objects.
```


```{r, nm=TRUE, solution = TRUE}
library(dplyr)
com_75 <- iris_75 %>%
  group_by(CODE_COM) %>%
  summarize(P14_POP = sum(P14_POP), 
            AREA = sum(AREA), 
            RESTAU = sum(RESTAU)) 

plot(st_geometry(iris_75), col = "ivory3", border = "ivory1")
plot(st_geometry(com_75), col = NA, border = "ivory4", lwd = 2, add = TRUE)
```








```{r, solution=TRUE}
library(sf)
library(cartography)
library(dplyr)
# Import data
fra <- st_read("data/fra.shp", quiet = TRUE)
# Create the variable
com_75$nb_rest_10000inhab <- 10000 * com_75$RESTAU / com_75$P14_POP
# Define breaks
bks <- getBreaks(v = com_75$nb_rest_10000inhab, method = "quantile", nclass = 4)
# Define color palette
cols <- carto.pal("wine.pal", length(bks)-1)

# Define plot margins
par(mar = c(0.2, 0.2, 1.4, 0.2), bg = "azure")
# Find EPCI bounding box
bb <- st_bbox(com_75)
# Plot France using EPCI boundingbox
plot(st_geometry(fra), col="ivory", border = "ivory3",
     xlim = bb[c(1, 3)], ylim = bb[c(2, 4)])
# Plot the choropleth layer
choroLayer(com_75, var = "nb_rest_10000inhab",
           breaks = bks, col = cols, lwd = 0.5,
           legend.pos = "topleft",add = TRUE, border = "white",
           legend.title.txt = "Number of restaurants\nfor 10,000 inhabitants")
# Plot proportionnal symbols
propSymbolsLayer(com_75, var="RESTAU", col="#ffffff80",border = "grey20",
                 legend.pos="left", inches=0.3, add = TRUE, lwd = 1,
                 legend.title.txt = "Number of restaurants")
# Add a layout layer
layoutLayer(title = "Restaurants", sources = "Insee, 2018",
            author = "Kim & Tim, 2018", tabtitle = TRUE, 
            theme = "green.pal", col = "darkred",
            coltitle = "white", 
            frame = TRUE, scale = 2)
# Add a north (south) arrow
north(pos = "topright", south = TRUE)


```




<!-- ```{r, nm=TRUE, echo=FALSE, eval=FALSE} -->
<!-- # Prepare data for following exercises -->
<!-- # sir_31 <- readRDS("data/sir_31.rds") -->
<!-- #  -->
<!-- # com_31 <- left_join(com_31, -->
<!-- #                     sir_31 %>% -->
<!-- #                       mutate(INSEE_COM=paste0(DEPET,COMET)) %>%  -->
<!-- #                       group_by(INSEE_COM) %>%  -->
<!-- #                       summarize(nb_of_rest= n()) %>%  -->
<!-- #                       st_set_geometry(NULL), -->
<!-- #                     by=c("INSEE_COM"="INSEE_COM")) %>%  -->
<!-- #   mutate(nb_of_rest=ifelse(is.na(nb_of_rest),0,nb_of_rest)) -->
<!-- #  -->
<!-- # table_MAUP <- readRDS("data/table_MAUP.rds") %>%  -->
<!-- #   select(CODGEO,EPCI) -->
<!-- #  -->
<!-- # epci_31  <- com_31 %>% -->
<!-- #   left_join(table_MAUP,by=c("INSEE_COM"="CODGEO")) %>%  -->
<!-- #   group_by(EPCI) %>%  -->
<!-- #   summarize(P14_POP=sum(P14_POP),nb_of_rest= sum(nb_of_rest)) %>%  -->
<!-- #   st_cast("MULTIPOLYGON") -->

<!-- #Saving objects for following exercises -->
<!-- #saveRDS(object = epci_31, file = "data/epci_31.rds") -->
<!-- #saveRDS(object = com_31, file = "data/com_31.rds") -->
<!-- ``` -->


<!-- ```{block, box.title = "7", box.body = list(fill = "white"), box.icon = "fa-star"} -->
<!-- Using the data contained in ‘sir_31’, add to this layer the number of restaurants per municipality.  -->
<!-- ``` -->

<!-- ```{block, opts.label = "information"} -->
<!-- The code of each municipality is not in the ‘sir_31’ database. To create it, you have to create a variable called *INSEE_COM* (5 digits) which concatenates the *DEPET* (2 digits) and *COMET* (3 digits) variables. -->
<!-- ``` -->

<!-- ```{r, nm=TRUE, solution = TRUE} -->

<!-- sir_31 <- readRDS("data/sir_31.rds") -->

<!-- com_31 <- left_join(com_31, -->
<!--                     sir_31 %>% -->
<!--                       mutate(INSEE_COM=paste0(DEPET,COMET)) %>%  -->
<!--                       group_by(INSEE_COM) %>%  -->
<!--                       summarize(nb_of_rest= n()) %>%  -->
<!--                       st_set_geometry(NULL), -->
<!--                     by=c("INSEE_COM"="INSEE_COM")) %>%  -->
<!--   mutate(nb_of_rest=ifelse(is.na(nb_of_rest),0,nb_of_rest)) -->
<!-- ``` -->

<!-- ```{block, box.title = "8", box.body = list(fill = "white"), box.icon = "fa-star"} -->
<!-- Aggregate all the information present in ‘com_31’ at the level of french intercommunalites (called EPCI) and call this new layer ‘epci_31’.  -->
<!-- ``` -->


<!-- ```{block, opts.label = "information"} -->
<!-- You have to use the database ‘table_MAUP.rds’ to have a match between the municipality code (*CODGEO*) and intercommunality code (*EPCI*). -->
<!-- ``` -->


<!-- ```{r, nm=TRUE, eval=FALSE, solution = TRUE} -->
<!-- table_MAUP <- readRDS("data/table_MAUP.rds") %>%  -->
<!--   select(CODGEO,EPCI) -->

<!-- epci_31  <- com_31 %>% -->
<!--   left_join(table_MAUP,by=c("INSEE_COM"="CODGEO")) %>%  -->
<!--   group_by(EPCI) %>%  -->
<!--   summarize(P14_POP=sum(P14_POP),nb_of_rest= sum(nb_of_rest)) %>%  -->
<!--   st_cast("MULTIPOLYGON") -->

<!-- plot(st_geometry(epci_31)) -->
<!-- ``` -->


<!-- ```{r, nm=TRUE, echo=FALSE} -->
<!-- table_MAUP <- readRDS("data/table_MAUP.rds") %>%  -->
<!--   select(CODGEO,EPCI) -->

<!-- epci_31  <- com_31 %>% -->
<!--   left_join(table_MAUP,by=c("INSEE_COM"="CODGEO")) %>%  -->
<!--   group_by(EPCI) %>%  -->
<!--   summarize(P14_POP=sum(P14_POP),nb_of_rest= sum(nb_of_rest)) %>%  -->
<!--   st_cast("MULTIPOLYGON") -->

<!-- plot(st_geometry(epci_31)) -->
<!-- ``` -->



<!-- ```{block, box.title = "9", box.body = list(fill = "white"), box.icon = "fa-star"} -->
<!-- Using the `cartography` package, simply plot a map of french intercommunality with a  proportional circle layer related to the number of restaurants. -->
<!-- ``` -->

<!-- ```{block, opts.label = "clues"} -->
<!-- The `propSymbolsLayer` function allows you to draw proportional circles. -->
<!-- ``` -->

<!-- ```{r, nm=TRUE, eval=FALSE, solution = TRUE} -->
<!-- library(cartography) -->
<!-- plot(st_geometry(epci_31), col = "ivory1", border = "ivory3",lwd =0.5,bg = "#FBEDDA") -->
<!-- propSymbolsLayer(epci_31, var = "nb_of_rest", inches = 0.2) -->
<!-- ``` -->

<!-- ```{r, nm=TRUE, echo=FALSE} -->
<!-- library(cartography) -->
<!-- plot(st_geometry(epci_31), col = "ivory1", border = "ivory3",lwd =0.5,bg = "#FBEDDA") -->
<!-- propSymbolsLayer(epci_31, var = "nb_of_rest", inches = 0.2) -->
<!-- ``` -->

# Exercise 2 : Static maps

We would like to design a map of Paris arrondissments that combines the number of restaurants and the number of restaurants per 10,000 inhabitants. 


```{block, box.title = "1", box.body = list(fill = "white"), box.icon = "fa-star"}
Data preparation:  

* Load the layer called 'com75_shp' (which contains the population and the number of restaurants in each arrondissement) and create a variable called *rest_per_10k* which corresponds to the number of restaurants per 10,000 inhabitants in each territory.  
* Create a vector of quantiles breaks of the *rest_per_10k* variable.   
* Create the vector colors which corresponds to a the number of classes defined earlier.  
* For ggplot2 maps, add  a variable called *typo* to 'com_75' which indicates the class of the territory according to the discretization contained in *bks* for the  *rest_per_10k* variable.  

```

```{block, opts.label = "information"}
For the creation of ‘bks’ et ‘cols’, use the `getBreaks` et `carto.pal` functions of the  `cartography` package.
For the creation of the *typo* variable, you can use the `cut` function and apply the parameters `digit.lab = 2` and `include.lowest = TRUE`.
```

```{r, solution=TRUE}
library(sf)
library(cartography)
# Import data
com_75 <- st_read("data/com_75.shp", quiet = TRUE)
# Create the variable
com_75$rest_per_10k <- 10000 * com_75$RESTAU / com_75$P14_POP
# Define breaks
bks <- getBreaks(v = com_75$rest_per_10k, method = "quantile", nclass = 4)
# Define color palette
# display.carto.all(n = 4)
cols <- carto.pal("wine.pal", length(bks)-1)



# For ggplot2 maps - Create a "typo"" variable
library(dplyr)
com_75 <- com_75 %>%
  mutate(typo = cut(rest_per_10k, breaks = bks, dig.lab = 2,
                    include.lowest = TRUE))
```


```{block, box.title = "2", box.body = list(fill = "white"), box.icon = "fa-star"}
With the help of `cartography` package, make the following map which contains in a choropleth layer the variable *rest_per_10k* and in a proportional circle layer the variable *RESTAU*. 
You can also try to do the same map using `ggplot2` and `tmap`  packages.
```


#### {.tabset} 
##### `cartography`

```{r, eval=TRUE, solution=TRUE, fig.width = 7, fig.height=4}
# Define plot margins
par(mar = c(0, 0, 1.2, 0), bg = "cornsilk")
# Plot the choropleth layer
choroLayer(com_75, var = "rest_per_10k",
           breaks = bks, col = cols, 
           border = "grey", lwd = 0.5,
           legend.pos = "topright", legend.horiz = T,
           legend.title.txt = "Number of restaurants\nper 10,000 inhabitants")
# Plot proportionnal symbols
propSymbolsLayer(com_75, var="RESTAU", 
                 inches=0.25, lwd = 1,
                 col="#ffffff90", border = "grey20",
                 legend.pos="right", 
                 legend.title.txt = "Number of restaurants")
# Add a layout layer
layoutLayer(title = "Restaurants Distribution in Paris", 
            sources = "Insee & SIRENE, 2018",
            author = "Kim, Tim & Comeetie, 2019", 
            tabtitle = TRUE, 
            col = "darkred", coltitle = "white", 
            frame = FALSE, scale = 2)
# Add a north (south) arrow
north(pos = "topleft")
```

##### `ggplot2`

```{r, eval=TRUE, solution=TRUE}
library(ggplot2)

map_ggplot <- ggplot() +
  geom_sf(data = com_75, colour = "ivory3",
          fill = "ivory") +
  geom_sf(data = com_75, aes(fill = typo), colour = "grey80") +
  scale_fill_manual(name = "Number of restaurants\nper 10,000 inhabitants",
                    values = cols, na.value = "#303030")+
  geom_sf(data = com_75 %>%  st_centroid(),
          aes(size= RESTAU), col="#f5f5f5",show.legend = 'point') +
  scale_size_area(max_size = 20, name = "number of restaurants" )+
  coord_sf(crs = 2154, datum = NA,
           xlim = st_bbox(com_75)[c(1,3)],
           ylim = st_bbox(com_75)[c(2,4)]
  ) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "azure",color=NA)) +
  labs(
    title = "Restaurants Distribution in Paris",
    caption = "Insee & SIRENE, 2018\nKim, Tim & Comeetie, 2019"
  )

plot(map_ggplot)

```






##### `tmap`

```{r, eval=TRUE, solution=TRUE}
library(tmap)
tm_shape(com_75) +
  tm_polygons("rest_per_10k", 
              breaks = bks,
              palette=cols, title = "Number of restaurants\nper 10,000 inhabitants") +
  tm_symbols(size = "RESTAU", col = "white",
             alpha = 0.5, scale = 3,
             title.size = "Number of Restaurants") +
  tm_layout(title = "Restaurants Distribution in Paris", 
            title.position = c("left", "top"), 
            legend.position = c("right", "top"), 
            frame = T, 
            inner.margins = c(0, 0, 0.1, 0)) + 
  tm_compass(type = "arrow", position = c("left", "top")) +
  tm_scale_bar(position = c("left", "bottom"), breaks = c(0,1,2)) + 
  tm_credits("Insee & SIRENE, 2018
Kim, Tim & Comeetie, 2019", position = c("left", "bottom"))
```
